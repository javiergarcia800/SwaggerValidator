<html>
  <head>
      <title>Swagger Validator</title>
      <link rel="stylesheet" href="swaggerValidator.css">
      <link rel="stylesheet" href="select.css">
      <link rel="stylesheet" href="codemirror/codemirror.css">
      <script src="codemirror/codemirror.js"></script>
      <script src="codemirror/javascript.js"></script>

      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
  </head>
  <body>

    <div class="header">
      <span class="image"><img src="swagger2.png"></span>
      <span class="text">Swagger validator</span>
    </div>

    <div class="titles">
      <div class="column">swagger.json</div>
      <div class="column" style="width: 19%;"></div>
      <div class="column">Response</div>
    </div>

    <div class="contents">
      <div class="content">
        <textarea  id="code" name="code" cols="30"></textarea>
      </div>
      <div class="content" style="width: 19%;">
        <div class="divContent">


          <div class="divCenter" style="color: #FFFFFF; font-size: 14px;">

              <div style="display: grid;">
                <span style="width: 100%; padding-bottom: 20px;">
                  <button style="width:100%" type="button" onclick="load();" id="load">Load Swagger</button>
                </span>
                <span  style="width: 100%; padding-bottom: 20px;">
                  <label for="path" style="font-size:15px;">Resource: </label>
                  <select style="width: 100%;" class="select-css" id="paths">
                    <option value="" style="color: #CDCDCD;">-- Seleccione --</option>
                  </select>
                </span>
                <span style="width: 100%; padding-bottom: 20px;">
                  <button style="width:100%" type="button" onclick="validate();" id="validate">Validate</button>
                </span>
                <span style="width: 100%; padding-bottom: 20px;">
                  <button style="width:100%" type="button" onclick="clean();" id="clean">Clean</button>
                </span>
              </div>

          </div>



        </div>
      </div>
      <div class="content">
        <textarea  id="code2" name="code2"  cols="30"></textarea>
      </div>
    </div>

  </body>


  <script>

      var swagger;

    var jsonSwaggerEditor = CodeMirror.fromTextArea(document.getElementById("code"), {
      matchBrackets: true,
      autoCloseBrackets: true,
      mode: "application/ld+json",
      lineWrapping: true,
      lineNumbers: true
    });

    var jsonResponseEditor = CodeMirror.fromTextArea(document.getElementById("code2"), {
      matchBrackets: true,
      autoCloseBrackets: true,
      mode: "application/ld+json",
      lineWrapping: true,
      lineNumbers: true
    });

    init();

    function init() {
      enableButtons(false);
    }

    function load() {
      // Se obtienen los jsons;
      var jsonSwagger = jsonSwaggerEditor.getValue();
      var jsonResponse = jsonResponseEditor.getValue();
      // console.log("jsonSwagger: " + jsonSwagger);
      // console.log("jsonResponseEditor: " + jsonResponse);

      if (jsonSwagger == "") {
        Swal.fire({
          icon: 'warning',
          html: '<p style="font-family: sans-serif">You must put a JSON Swagger to load the resources!</p>',
        });
        return;
      }

      // Se convierten a objetos los JSONs.
      swagger = JSON.parse(jsonSwagger);
      var response = JSON.parse(jsonSwagger);
      //console.log("swagger:" + swagger);
      //console.log("response:" + response);

      // Se obtienen los resources
      var resources = Object.keys(swagger.paths);
      loadPaths(resources);
      //console.log("Resources:" + resources);
      //console.log(resources[0]);

      // Se obtiene el objeto por key
      //var obj1 = swagger.paths["/solicitudIndividual"];
      //console.log(obj1);

      // Se habilitan los botones.
      enableButtons(true);
    }

    function loadPaths(paths) {
      var select = document.getElementById("paths");

      // Remove options
      for (var i = select.length - 1; i > 0; i--) {
	       select.remove(i);
       }

       // Add options
      for (var i = 0; i< paths.length; i++){
        var opt = document.createElement('option');
        opt.value = paths[i];
        opt.innerHTML = paths[i];
        select.appendChild(opt);
      }
    }

    function enableButtons(enable) {
      var select = document.getElementById("paths");
      var clean = document.getElementById("clean");
      var validate = document.getElementById("validate");
      if (enable) {
        select.disabled = "";
        clean.disabled = "";
        validate.disabled = "";
      } else {
        select.disabled = true;
        clean.disabled = true;
        validate.disabled = true;
      }
    }

    function clean() {
      enableButtons(false);
      var select = document.getElementById("paths");

      // Remove options
      for (var i = select.length - 1; i > 0; i--) {
	       select.remove(i);
       }
    }

    function validate() {
      var select = document.getElementById("paths");
      var resource = select.value;
      if (resource == "") {
        Swal.fire({
          icon: 'warning',
          html: '<p style="font-family: sans-serif">You must select a Resource to validate the JSON Response!</p>',
        });
        return;
      }

      // Se obtienen los jsons;
      var jsonSwagger = jsonSwaggerEditor.getValue();
      var jsonResponse = jsonResponseEditor.getValue();
      if (jsonSwagger == "") {
        Swal.fire({
          icon: 'warning',
          html: '<p style="font-family: sans-serif">You must put a JSON Swagger to validate the JSON Response!</p>',
        });
        return;
      }
      if (jsonResponse == "") {
        Swal.fire({
          icon: 'warning',
          html: '<p style="font-family: sans-serif">You must put a JSON Response to validate the JSON Response!</p>',
        });
        return;
      }

      // Se convierten los JSONs a objetos JavaScript.
      swagger = JSON.parse(jsonSwagger);
      var response = JSON.parse(jsonResponse);

      // Se obtiene el objeto por key
      var jsonResource = swagger.paths[resource];
      //console.log(jsonResource);
      var methods = Object.keys(jsonResource);



      // TODO solo se considera el primer metodo por Recurso.
      var method = methods[0];



      var responses = Object.keys(swagger.paths[resource][method]["responses"]);
      var consumes;
      var produces;
      var description = Object.keys(swagger.paths[resource][method]["description"]);

      if (swagger.paths[resource][method]["consumes"] != undefined) {
          consumes = Object.keys(swagger.paths[resource][method]["consumes"]);
      }
      if (swagger.paths[resource][method]["produces"] != undefined) {
          produces = Object.keys(swagger.paths[resource][method]["produces"]);
      }

      //console.log("responses: " + responses);
      //console.log("consumes[0]: " + consumes[0]);
      //console.log("produces[0]: " + produces[0]);
      //console.log("description: " + description);

      var code = responses[0];
      //console.log("code: " + code);
      var description = swagger.paths[resource][method]["responses"][code].description;
      //console.log("descripcion: " + description);
      var ref = swagger.paths[resource][method]["responses"][code].schema["$ref"];
      var definition = ref.substring(ref.lastIndexOf("/") + 1, ref.length);
      //console.log("definition: " + definition);

      var objDefinitionSwagger = getDefinition(definition);
      console.log("objDefinitionSwagger");
      console.log(objDefinitionSwagger);

      var paths=[];
      validateJSONResponse(objDefinitionSwagger, response, paths);
    }

    function validateJSONResponse(objDefinitionSwagger, objResponse, paths) {
      console.log("***validateJSONResponse***");

      // Se obtienen los nodos hijos del Response.
      var childs = Object.entries(objResponse);
      var keyValue;
      var key;
      var value;
      var path;
      for (var i=0; i< childs.length; i++) {
        key = childs[i][0];
        value = childs[i][1];
        console.log("key:" + key);
        console.log("value:");
        console.log(value);
        if (typeof value === 'object') {
            path = {"name": key, "type": "object"};
            paths.push(path);
            validatePath(objDefinitionSwagger, objResponse, paths);
        }
      }
    }


    function validatePath(objDefinitionSwagger, objResponse, paths) {
        /*console.log("***validatePath***");
        console.log("Paths[]:");
        console.log(paths);*/

        //console.log("***Se obtiene el postPath para obtener el definitionSwagger");
        // Se obtiene la definicion Swager del nodo a validar.
        var postPathDefinitionSwagger = "";
        var path; // {name: 'documento', type: 'object'}
        for (var i=0; i < paths.length; i++) {
            path = paths[i];
            //console.log("validatePath() path: ");
            //console.log(path);
            if (path.type == 'item') {
                console.log("Falta validar: item!!!!");
                //postPathDefinitionSwagger = postPathDefinitionSwagger + ".item['" + path.name + "']";
            } else if (path.type == 'object') {
                postPathDefinitionSwagger = postPathDefinitionSwagger + "." + path.name;
            } else if (path.type == 'array') {
                postPathDefinitionSwagger = postPathDefinitionSwagger + ".item";
            } else if (path.type == 'string') {
                postPathDefinitionSwagger = postPathDefinitionSwagger + "." + path.name;
            } else if (path.type == 'integer') {
                postPathDefinitionSwagger = postPathDefinitionSwagger + "." + path.name;
            }
        }

        //console.log("*** Se valida el Path: " + path.name); // respuesta

        // En construye un objeto en base al path.



        //console.log("postPathDefinitionSwagger:" + postPathDefinitionSwagger);

        // Se intenta construir un objeto con la defincion del swagger.
        var objSwagger = eval("objDefinitionSwagger" + postPathDefinitionSwagger);
        //console.log("objSwagger:");
        //console.log(objSwagger);

        if (objSwagger == undefined) {
            console.log("El atributo [" + path.name + "] no existe en la definición swagger!");
            return;
        }
        if (path.type !== objSwagger.type && path.type != "null") {
            console.log("El atributo [" + path.name + "] esta definido como ['" + objSwagger.type+ "'] pero es de tipo ['" + path.type + "']!");
            return;
        } else {
            console.log("OK El atributo: ['" + path.name + "']");
        }

        /*if (path.type == 'object' && objSwagger.type !== 'object') {
            console.log("El atributo [" + path.name + "] esta definido como ['" + objSwagger.type+ "'] pero es de tipo ['" + path.type + "']!");
            return;
        } else if (path.type == 'string' && objSwagger.type !== 'string') {
            console.log("El atributo [" + path.name + "] esta definido como ['" + objSwagger.type + "'] pero es de tipo ['" + path.type + "']!");
            return;
        } else if (path.type == 'integer' && objSwagger.type !== 'integer') {
            console.log("El atributo [" + path.name + "] esta definido como ['" + objSwagger.type + "'] pero es de tipo ['" + path.type + "']!");
            return;
        } else if (path.type == 'array' && objSwagger.type !== 'array' ) {
            console.log("El atributo [" + path.name + "] esta definido como ['" + objSwagger.type + "'] pero es de tipo ['" + path.type + "']!");
            return;
        } else {
            console.log("OK El atributo: ['" + path.name + "']");
        }*/


        //console.log("*** Se obtiene el postPath para obtener el objeto hijo del Response");
        if (path.type == 'object' || path.type == 'array') {
            var pathResponse = null;
            var postPathResponse = "";
            for (var i=0; i < paths.length; i++) {
                pathResponse = paths[i];

                //console.log("path.type:" + pathResponse.type);
                //console.log("path.name:" + pathResponse.name);

                if (pathResponse.type == 'array') {
                    postPathResponse = postPathResponse + "['" + pathResponse.name + "']";
                } else if (pathResponse.type == 'object') {
                    postPathResponse = postPathResponse + "." + pathResponse.name;
                } else if (pathResponse.type == 'item') {
                    postPathResponse = postPathResponse + "[" + pathResponse.name + "]";
                }
            }

            //console.log("Obtener del Response:" + "Object.entries(objResponse" + postPathResponse + ")");
            // Se obtienen los nodos hijos del response
            var childsResponse = eval("Object.entries(objResponse" + postPathResponse + ")");

            for (var i=0; i< childsResponse.length; i++) {
                key = childsResponse[i][0];
                value = childsResponse[i][1];
                /*console.log("key:" + key);
                console.log("value:" );
                console.log(value);*/

                // Si el nodo hijo es un array se validan los nodos hijos del array.
                //if (!isNaN(key)) {
                if (Array.isArray(value)) {

                    // Se obtiene el número de elementos del array.
                    //console.log("arrayLength:" + "objResponse" + postPathResponse + "." + key + ".length");
                    var arrayLength = eval("objResponse" + postPathResponse + "." + key + ".length");
                    //console.log("arrayLength: " + arrayLength);
                    for (var k = 0; k < arrayLength; k++) {

                        // Se obtienen las propiedades de cada elemento del array.
                        var childsArrayResponse = eval("Object.entries(objResponse" + postPathResponse + "." + key + "[" + k + "])");
                        for (var j=0; j< childsArrayResponse.length; j++) {
                            keyChild = childsArrayResponse[j][0];
                            valueChild = childsArrayResponse[j][1];
                            typeChild = getType(valueChild);

                            //console.log("Dentro de Number key: " + keyChild);
                            //console.log("Dentro de Number value: " + valueChild);

                            newPaths = paths.slice();

                            // Se agrega el nodo padre del array.
                            path = {"name": key, "type": "object"};
                            newPaths.push(path);

                            // Se agrega el identificador de array.
                            path = {"type": "array"};
                            newPaths.push(path);

                            // Se agrega cada elemento del array.
                            path = {"name": keyChild, "type": typeChild};
                            newPaths.push(path);
                            validatePath(objDefinitionSwagger, objResponse, newPaths);
                        }
                    }
                } else {

                    type = getType(value);
                    path = {"name": key, "type": type};
                    newPaths = paths.slice();
                    newPaths.push(path);
                    validatePath(objDefinitionSwagger, objResponse, newPaths);

                }
            }
        }
    }

    function getType(value) {
        if (value == null) {
            return "null";
        } else if (Array.isArray(value)) {
            return "array";
        } else if (typeof value === 'object') {
            return "object";
        } else if (typeof value === 'string') {
            return "string";
        } else if (typeof value === 'number') {
            return "integer";
        } else if (typeof value === 'boolean') {
            return "boolean";
        }
    }

    function getNode(nodeSwaggerDefinition) {
        //console.log("getNode() nodeSwaggerDefinition:");
        //console.log(nodeSwaggerDefinition);

        var typeOrRef = Object.keys(nodeSwaggerDefinition);
        //console.log("typeOrRef:");
        //console.log(typeOrRef);

        //console.log("typeOrRef[0]:" + typeOrRef[0]);
        // Se valida si es type o Ref
        if ( typeOrRef[0] == "$ref" ) {
            var propertyRef = nodeSwaggerDefinition[typeOrRef[0]];
            //console.log("propertyRef: " + propertyRef);
            var propertyDefinition = propertyRef.substring(propertyRef.lastIndexOf("/") + 1, propertyRef.length);
            return getDefinition(propertyDefinition);
        } else if ( typeOrRef[0] == "type" ) {

            var typeOfProperty = nodeSwaggerDefinition[typeOrRef[0]];
            //console.log("typeOfProperty:" + typeOfProperty );
            if (typeOfProperty == "string") {
                var obj = Object.create({});
                obj.type = "string";
                return obj;
            } else if (typeOfProperty == "integer") {
                var obj = Object.create({});
                obj.type = "integer";
                return obj;
            } else if (typeOfProperty == "boolean") {
                var obj = Object.create({});
                obj.type = "boolean";
                return obj;
            }

            else if (typeOfProperty == 'object'){
                var arrayProperties = Object.keys(nodeSwaggerDefinition["properties"]);
                obj.type = "object";

                // Por cada propiedad se consultan sus items.
                for (var i = 0; i < arrayProperties.length; i++) {
                    property = arrayProperties[i];
                    //console.log("property:" + property);
                    obj[property] = getNode(nodeSwaggerDefinition["properties"][property]);

                    //console.log("obj[" + property + "]");
                    //console.log(obj[property]);
                }

                return obj;
            } else if (typeOfProperty == 'array') {
                //console.log("TODO typeOfProperty: Array.......");
                // Se obtienen los items del array.
                // Se obtiene el tipo de objecto del item del array.
                var typeOrRef = Object.keys(nodeSwaggerDefinition["items"]);
                //console.log("getDefinition() item:" + typeOrRef);
                //console.log("getDefinition()typeOrRef[0]=" + typeOrRef[0]);

                var obj = Object.create({});
                obj.type = "array";
                obj.item = [];

                if ( typeOrRef[0] == "$ref" ) {
                    var propertyRef = nodeSwaggerDefinition["items"][typeOrRef[0]];
                    //console.log("propertyRef:" + propertyRef);
                    //console.log("propertyRef: " + propertyRef);
                    var propertyDefinition = propertyRef.substring(propertyRef.lastIndexOf("/") + 1, propertyRef.length);
                    //console.log("propertyDefinition:" + propertyDefinition);
                    //obj.item["object"] = getDefinition(propertyDefinition);   ************************

                    obj["item"] = getDefinition(propertyDefinition);
                } else if (typeOrRef[0] == "type") {
                    var typeOfProperty = nodeSwaggerDefinition["items"]["type"];
                    //console.log("typeOfProperty:" + typeOfProperty );
                    if (typeOfProperty == "string") {
                        var objProperty = Object.create({});
                        objProperty.type = "string";
                    } else if (typeOfProperty == "integer") {
                        var objProperty = Object.create({});
                        oobjPropertybj.type = "integer";
                    } else if (typeOfProperty == "boolean") {
                        var objProperty = Object.create({});
                        objProperty.type = "boolean";
                    } else {
                        console.log("TIPO DE PROPIEDAD NO PROGRAMADA!!!");
                    }


                    obj["item"] = objProperty;
                }

                return obj;
            }
        }
    }

    function getDefinition(definition) {
        var obj = Object.create({});
        var property;
        //console.log("defintion:" + definition);

        // Se obtiene el tipo de nodo del Swagger.
        var typeDefinitionSwagger = swagger.definitions[definition]["type"];
        //console.log("typeDefinitionSwagger:" + typeDefinitionSwagger);

        if (typeDefinitionSwagger == 'object') {
            // Si es un objeto se obtienen las propiedades.
            var arrayProperties = Object.keys(swagger.definitions[definition]["properties"]);

            obj.type = "object";


            // Por cada propiedad se consultan sus items.
            for (var i = 0; i < arrayProperties.length; i++) {
                property = arrayProperties[i];
                //console.log("property:" + property);
                obj[property] = getNode(swagger.definitions[definition]["properties"][property]);

                //console.log("obj[" + property + "]");
                //console.log(obj[property]);
            }
        } else if (typeDefinitionSwagger == 'array') {
            obj.type = "array";
            //obj.item = []; **********************

            // Se obtiene el tipo de objecto del item del array.
            var typeOrRef = Object.keys(swagger.definitions[definition]["items"]);
            console.log("getDefinition() typeOrRef:" + typeOrRef);
            //console.log("getDefinition()typeOrRef[0]=" + typeOrRef[0]);
            if ( typeOrRef[0] == "$ref" ) {

                objProperties = Object.create({});
                objProperties.type= "object";

                var propertyRef = swagger.definitions[definition]["items"][typeOrRef[0]];
                var propertyDefinition = propertyRef.substring(propertyRef.lastIndexOf("/") + 1, propertyRef.length);
                objProperties.item["object"] = getDefinition(propertyDefinition);

                //obj.item["object"] = objProperties;  *******************
                obj["item"] = objProperties;

            } else if (typeOrRef[0] == "type") {
                objProperties = Object.create({});
                objProperties.type= "object";

                // Por cada propiedad se consultan sus items.
                var arrayProperties = Object.keys(swagger.definitions[definition]["items"]["properties"]);
                console.log("getDefinition() arrayProperties:");
                console.log(arrayProperties);
                for (var i = 0; i < arrayProperties.length; i++) {
                    property = arrayProperties[i];
                    console.log("property:" + property);
                    objProperties[property] = getNode(swagger.definitions[definition]["items"]["properties"][property]);
                }

                //obj.item["object"] = objProperties;   *******************
                obj["item"] = objProperties;
            }
        }

        //console.log("getDefinition.obj");
        //console.log(obj);

        return obj;



        /*
        console.log("typeDefinitionSwagger:" );
        console.log(typeDefinitionSwagger);
        if (typeDefinitionSwagger == 'array') {
            // Si es de tipo 'array' se obtienen sus items.
            var arrayProperties = Object.keys(swagger.definitions[definition]["items"]["properties"]);

            var objObject = Object.create({});
            // Se iteran las propiedades para agregarlas al objeto.
            for (var i = 0; i < arrayProperties.length; i++) {
                property = arrayProperties[i];
                //console.log("arrayProperties[i]:" + property);

                // Se valida si el nodo es requerido.
                var required = false;
                if (swagger.definitions[definition]["required"] != null) {
                    var itemsRequired = swagger.definitions[definition]["required"];
                    //console.log("itemsRequired: " + itemsRequired);
                    required = itemsRequired.indexOf(property) > -1;
                    //console.log("required: " + required + " para property:" + property);
                }

                // Se obtiene si la propiedad es de tipo: type o 'Ref'.
                var typeOrRef = Object.keys(swagger.definitions[definition]["item"]["properties"][property]);
                //console.log("typeOrRef[0]:" + typeOrRef[0]);
                //console.log("typeOrRef:" + typeOrRef);

                // Si es de tipo ref se obtiene la definicion del objeto 'Ref'erenciado.

                if (typeOrRef[0] == "$ref") {
                    objObject[property] = getObjPropertyOfRef(swagger, definition, property);
                } else if (typeOrRef[0] == "type") {
                    objObject[property] = getObjPropertyOfType(swagger, definition, property);
                }
                //console.log("obj");
                //console.log(obj);

            }

            obj = {
                type: "array",
                array: {
                    "type": 'object',
                    "object": objObject
                }
            };
        }


        // Si el tipo de nodo es 'object' se obtienen sus propiedades.
        else if (typeDefinitionSwagger == 'object') {
            // Si es de tipo 'object' se obtienen sus propiedades.
            var arrayProperties = Object.keys(swagger.definitions[definition]["properties"]);

            // Se iteran las propiedades para agregarlas al objeto.
            for (var i = 0; i < arrayProperties.length; i++) {
                property = arrayProperties[i];
                //console.log("arrayProperties[i]:" + property);

                // Se valida si el nodo es requerido.
                var required = false;
                if (swagger.definitions[definition]["required"] != null) {
                    var itemsRequired = swagger.definitions[definition]["required"];
                    //console.log("itemsRequired: " + itemsRequired);
                    required = itemsRequired.indexOf(property) > -1;
                    //console.log("required: " + required + " para property:" + property);
                }

                // Se obtiene si la propiedad es de tipo: type o 'Ref'.
                var typeOrRef = Object.keys(swagger.definitions[definition]["properties"][property]);
                //console.log("typeOrRef[0]:" + typeOrRef[0]);
                //console.log("typeOrRef:" + typeOrRef);

                // Si es de tipo ref se obtiene la definicion del objeto 'Ref'erenciado.
                if (typeOrRef[0] == "$ref") {
                    obj[property] = getObjPropertyOfRef(swagger, definition, property);
                } else if (typeOrRef[0] == "type") {
                    obj[property] = getObjPropertyOfType(swagger, definition, property);
                }
                //console.log("obj");
                //console.log(obj);
            }
        }

        return obj;
        */


    }

    /*
    function getObjPropertyOfRef(swagger, definition, property) {
        var propertyRef = getPropertyDefinition(swagger, definition, property);

        //console.log("propertyDefinition: " + propertyRef);
        var item = getDefinition(swagger, propertyRef);
        var objPropery = {
                        "type" : "object",
                        "required": false };
        objProperty["respuesta"] = item;
        var obj = Object.create({});
        obj["object"] = objPropery;

        return obj;
    }

    function getObjPropertyOfType(swagger, definition, property) {
        var obj = Object.create({});
        var type = swagger.definitions[definition]["properties"][property]["type"];
        if (type == "array") {
            var propertyRef = swagger.definitions[definition]["properties"][property]["items"]["$ref"];
            //console.log("array[].propertyRef=" + propertyRef);
            var propertyDefinition = propertyRef.substring(propertyRef.lastIndexOf("/") + 1, propertyRef.length);
            //console.log("array[].propertyDefinition=" + propertyDefinition);
            var items = getDefinition(swagger, propertyDefinition);
            return {
                      "type": "array",
                      "item": items,
                      "required": required
                      };
        } else {
            //console.log("property:" + property);
            //console.log("required:" + required);
            //console.log("type:" + type);
            //console.log("object.create()....");
            //console.log(Object.create({"type": type}));
            return {
                     "type": type,
                     "required": required
                 };
            //console.log("obj");
            //console.log(obj);
        }
    }

    function getPropertyDefinition(swagger, definition, property) {
        var propertyRef = swagger.definitions[definition]["properties"][property]["$ref"];
        //console.log("propertyDefinition:" + propertyRef);
        var propertyDefinition = propertyRef.substring(propertyRef.lastIndexOf("/") + 1, propertyRef.length);
        return propertyDefinition;
    }*/

  </script>

</html>
